#!/usr/bin/env python3
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.linear_model import Ridge
from sklearn.metrics import r2_score
from sklearn.preprocessing import StandardScaler
import os

RESULTS = "results"
FIGS = "figs"

os.makedirs(RESULTS, exist_ok=True)
os.makedirs(FIGS, exist_ok=True)

def load_joint():
    # Uses joint_ioi_anti_repeat_all.csv generated earlier
    path = os.path.join("results", "joint_ioi_anti_repeat_all.csv")
    return pd.read_csv(path)

def build_feature_matrix(df):
    feats = df[["abs_delta_ioi", "abs_delta_anti"]].values
    return feats

def main():
    df = load_joint()

    # Select two models
    A = df[df["model"] == "pythia-410m"].copy()
    B = df[df["model"] == "gpt2-medium"].copy()

    if len(A) == 0 or len(B) == 0:
        raise ValueError("Models missing from joint table.")

    X = build_feature_matrix(A)
    Y = build_feature_matrix(B)

    # Standardize
    scalerX = StandardScaler()
    scalerY = StandardScaler()
    Xs = scalerX.fit_transform(X)
    Ys = scalerY.fit_transform(Y)

    # Fit linear model: X → Y
    model = Ridge(alpha=1e-3)
    model.fit(Xs, Ys)
    Y_pred = model.predict(Xs)

    r2 = r2_score(Ys, Y_pred, multioutput="uniform_average")

    out_path = os.path.join(RESULTS, "learned_alignment_summary.txt")
    with open(out_path, "w") as f:
        f.write(f"Model: pythia-410m → gpt2-medium\n")
        f.write(f"R^2 mean: {r2:.4f}\n")
        f.write(f"Coefficients:\n{model.coef_}\n")
        f.write(f"Intercept:\n{model.intercept_}\n")

    # Scatter plot
    plt.figure(figsize=(6,6))
    plt.scatter(Ys[:,0], Y_pred[:,0], s=20, alpha=0.7, label="IOI")
    plt.scatter(Ys[:,1], Y_pred[:,1], s=20, alpha=0.7, label="Anti-Repeat")
    plt.plot([-3,3], [-3,3], 'k--')
    plt.xlabel("True standardized target feature")
    plt.ylabel("Predicted")
    plt.title(f"Learned Alignment: Pythia410M → GPT2-Medium\nR²={r2:.3f}")
    plt.legend()
    plt.tight_layout()
    plt.savefig(os.path.join(FIGS, "learned_alignment_scatter.png"))

    print("[OUT] Saved learned alignment summary and plot.")

if __name__ == "__main__":
    main()

